<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>订阅消息 | 大前端 - 前端高级进阶</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="大前端课程电子书">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/notes-page/assets/css/0.styles.ee344319.css" as="style"><link rel="preload" href="/notes-page/assets/js/app.48cb01bf.js" as="script"><link rel="preload" href="/notes-page/assets/js/8.c8491ce8.js" as="script"><link rel="preload" href="/notes-page/assets/js/47.98971016.js" as="script"><link rel="prefetch" href="/notes-page/assets/js/1.31400db7.js"><link rel="prefetch" href="/notes-page/assets/js/10.591ed5a3.js"><link rel="prefetch" href="/notes-page/assets/js/100.e1ea6413.js"><link rel="prefetch" href="/notes-page/assets/js/101.e57008d7.js"><link rel="prefetch" href="/notes-page/assets/js/102.b41995eb.js"><link rel="prefetch" href="/notes-page/assets/js/103.7fecd5f1.js"><link rel="prefetch" href="/notes-page/assets/js/104.0ca339c0.js"><link rel="prefetch" href="/notes-page/assets/js/105.7bb4e3f4.js"><link rel="prefetch" href="/notes-page/assets/js/106.6f5c5c49.js"><link rel="prefetch" href="/notes-page/assets/js/107.8ebb5390.js"><link rel="prefetch" href="/notes-page/assets/js/108.062a2e35.js"><link rel="prefetch" href="/notes-page/assets/js/109.91bfdb63.js"><link rel="prefetch" href="/notes-page/assets/js/11.fe04a3c6.js"><link rel="prefetch" href="/notes-page/assets/js/110.eb958663.js"><link rel="prefetch" href="/notes-page/assets/js/111.2bb4854f.js"><link rel="prefetch" href="/notes-page/assets/js/112.b01f3627.js"><link rel="prefetch" href="/notes-page/assets/js/113.0f134a95.js"><link rel="prefetch" href="/notes-page/assets/js/114.57a79d59.js"><link rel="prefetch" href="/notes-page/assets/js/115.cabe7e62.js"><link rel="prefetch" href="/notes-page/assets/js/116.bfad15db.js"><link rel="prefetch" href="/notes-page/assets/js/117.e7f6f9ed.js"><link rel="prefetch" href="/notes-page/assets/js/118.55ef2c03.js"><link rel="prefetch" href="/notes-page/assets/js/119.0c99b4cf.js"><link rel="prefetch" href="/notes-page/assets/js/12.3c7e7da5.js"><link rel="prefetch" href="/notes-page/assets/js/120.e113bfab.js"><link rel="prefetch" href="/notes-page/assets/js/121.ff8c444e.js"><link rel="prefetch" href="/notes-page/assets/js/122.0263b9b3.js"><link rel="prefetch" href="/notes-page/assets/js/123.f72f78e5.js"><link rel="prefetch" href="/notes-page/assets/js/124.bd444462.js"><link rel="prefetch" href="/notes-page/assets/js/125.03282748.js"><link rel="prefetch" href="/notes-page/assets/js/126.81c7fdeb.js"><link rel="prefetch" href="/notes-page/assets/js/127.21dfbee7.js"><link rel="prefetch" href="/notes-page/assets/js/128.1d09006b.js"><link rel="prefetch" href="/notes-page/assets/js/129.28ddf7b2.js"><link rel="prefetch" href="/notes-page/assets/js/13.1b9e3060.js"><link rel="prefetch" href="/notes-page/assets/js/130.00114083.js"><link rel="prefetch" href="/notes-page/assets/js/131.cd04b035.js"><link rel="prefetch" href="/notes-page/assets/js/132.0888eb6a.js"><link rel="prefetch" href="/notes-page/assets/js/133.008bd124.js"><link rel="prefetch" href="/notes-page/assets/js/134.84efc02a.js"><link rel="prefetch" href="/notes-page/assets/js/135.bc634118.js"><link rel="prefetch" href="/notes-page/assets/js/136.232b66fa.js"><link rel="prefetch" href="/notes-page/assets/js/137.683d644e.js"><link rel="prefetch" href="/notes-page/assets/js/138.38c7fcd6.js"><link rel="prefetch" href="/notes-page/assets/js/139.2387d75b.js"><link rel="prefetch" href="/notes-page/assets/js/14.69a07fe4.js"><link rel="prefetch" href="/notes-page/assets/js/140.151eaabd.js"><link rel="prefetch" href="/notes-page/assets/js/141.c93f199a.js"><link rel="prefetch" href="/notes-page/assets/js/142.8b14b78f.js"><link rel="prefetch" href="/notes-page/assets/js/143.ee715425.js"><link rel="prefetch" href="/notes-page/assets/js/144.190ac1aa.js"><link rel="prefetch" href="/notes-page/assets/js/145.8a8da0f4.js"><link rel="prefetch" href="/notes-page/assets/js/146.3124d9e7.js"><link rel="prefetch" href="/notes-page/assets/js/147.9837800c.js"><link rel="prefetch" href="/notes-page/assets/js/148.b33746b3.js"><link rel="prefetch" href="/notes-page/assets/js/149.2bcb10fe.js"><link rel="prefetch" href="/notes-page/assets/js/15.9170b302.js"><link rel="prefetch" href="/notes-page/assets/js/150.6dd77236.js"><link rel="prefetch" href="/notes-page/assets/js/151.911a509a.js"><link rel="prefetch" href="/notes-page/assets/js/152.7c5ad300.js"><link rel="prefetch" href="/notes-page/assets/js/153.c2dc04cf.js"><link rel="prefetch" href="/notes-page/assets/js/154.3ae35901.js"><link rel="prefetch" href="/notes-page/assets/js/155.125a40ec.js"><link rel="prefetch" href="/notes-page/assets/js/156.5eaaeb86.js"><link rel="prefetch" href="/notes-page/assets/js/157.be8c0a02.js"><link rel="prefetch" href="/notes-page/assets/js/158.4dac9f2b.js"><link rel="prefetch" href="/notes-page/assets/js/159.4e31e0d0.js"><link rel="prefetch" href="/notes-page/assets/js/16.5f849cca.js"><link rel="prefetch" href="/notes-page/assets/js/160.ff2973db.js"><link rel="prefetch" href="/notes-page/assets/js/161.d872543d.js"><link rel="prefetch" href="/notes-page/assets/js/162.57fa35c3.js"><link rel="prefetch" href="/notes-page/assets/js/163.7526015e.js"><link rel="prefetch" href="/notes-page/assets/js/164.6dc55ad2.js"><link rel="prefetch" href="/notes-page/assets/js/165.17ff707c.js"><link rel="prefetch" href="/notes-page/assets/js/166.2aa7c665.js"><link rel="prefetch" href="/notes-page/assets/js/17.87ce190e.js"><link rel="prefetch" href="/notes-page/assets/js/18.116da803.js"><link rel="prefetch" href="/notes-page/assets/js/19.9d38c915.js"><link rel="prefetch" href="/notes-page/assets/js/20.3f86300d.js"><link rel="prefetch" href="/notes-page/assets/js/21.03fea8ee.js"><link rel="prefetch" href="/notes-page/assets/js/22.8c94a5a0.js"><link rel="prefetch" href="/notes-page/assets/js/23.d2e28606.js"><link rel="prefetch" href="/notes-page/assets/js/24.2aa9cdcd.js"><link rel="prefetch" href="/notes-page/assets/js/25.f3e549b7.js"><link rel="prefetch" href="/notes-page/assets/js/26.e7185b4d.js"><link rel="prefetch" href="/notes-page/assets/js/27.9b4600fd.js"><link rel="prefetch" href="/notes-page/assets/js/28.52a49eef.js"><link rel="prefetch" href="/notes-page/assets/js/29.8e79f4b3.js"><link rel="prefetch" href="/notes-page/assets/js/30.dc474686.js"><link rel="prefetch" href="/notes-page/assets/js/31.34eebdf0.js"><link rel="prefetch" href="/notes-page/assets/js/32.121d8469.js"><link rel="prefetch" href="/notes-page/assets/js/33.9dd66a66.js"><link rel="prefetch" href="/notes-page/assets/js/34.05b9a00c.js"><link rel="prefetch" href="/notes-page/assets/js/35.2dd0c1ed.js"><link rel="prefetch" href="/notes-page/assets/js/36.42ae55f6.js"><link rel="prefetch" href="/notes-page/assets/js/37.5accc30c.js"><link rel="prefetch" href="/notes-page/assets/js/38.430657c9.js"><link rel="prefetch" href="/notes-page/assets/js/39.8e4e1df5.js"><link rel="prefetch" href="/notes-page/assets/js/40.38eb3fdd.js"><link rel="prefetch" href="/notes-page/assets/js/41.cba82d3b.js"><link rel="prefetch" href="/notes-page/assets/js/42.7a88764c.js"><link rel="prefetch" href="/notes-page/assets/js/43.c45af308.js"><link rel="prefetch" href="/notes-page/assets/js/44.a730a19e.js"><link rel="prefetch" href="/notes-page/assets/js/45.f39c3539.js"><link rel="prefetch" href="/notes-page/assets/js/46.6065ecbd.js"><link rel="prefetch" href="/notes-page/assets/js/48.38dd5b62.js"><link rel="prefetch" href="/notes-page/assets/js/49.aeeb65ad.js"><link rel="prefetch" href="/notes-page/assets/js/50.1dad813c.js"><link rel="prefetch" href="/notes-page/assets/js/51.c108a1fa.js"><link rel="prefetch" href="/notes-page/assets/js/52.29f2b71c.js"><link rel="prefetch" href="/notes-page/assets/js/53.9f37aff8.js"><link rel="prefetch" href="/notes-page/assets/js/54.1692dc9c.js"><link rel="prefetch" href="/notes-page/assets/js/55.542a41fb.js"><link rel="prefetch" href="/notes-page/assets/js/56.127ceac2.js"><link rel="prefetch" href="/notes-page/assets/js/57.42a0d85c.js"><link rel="prefetch" href="/notes-page/assets/js/58.5a5d69a6.js"><link rel="prefetch" href="/notes-page/assets/js/59.ab50eab6.js"><link rel="prefetch" href="/notes-page/assets/js/6.98fac1b9.js"><link rel="prefetch" href="/notes-page/assets/js/60.af3450ad.js"><link rel="prefetch" href="/notes-page/assets/js/61.7a409d14.js"><link rel="prefetch" href="/notes-page/assets/js/62.2ffa79be.js"><link rel="prefetch" href="/notes-page/assets/js/63.60116912.js"><link rel="prefetch" href="/notes-page/assets/js/64.da045550.js"><link rel="prefetch" href="/notes-page/assets/js/65.93e06b89.js"><link rel="prefetch" href="/notes-page/assets/js/66.f5cf7d7d.js"><link rel="prefetch" href="/notes-page/assets/js/67.d965a543.js"><link rel="prefetch" href="/notes-page/assets/js/68.15ea2924.js"><link rel="prefetch" href="/notes-page/assets/js/69.58f43b83.js"><link rel="prefetch" href="/notes-page/assets/js/7.0a6a3e08.js"><link rel="prefetch" href="/notes-page/assets/js/70.a01ccd1b.js"><link rel="prefetch" href="/notes-page/assets/js/71.13235a6f.js"><link rel="prefetch" href="/notes-page/assets/js/72.06e78f13.js"><link rel="prefetch" href="/notes-page/assets/js/73.56f3da5f.js"><link rel="prefetch" href="/notes-page/assets/js/74.e8482133.js"><link rel="prefetch" href="/notes-page/assets/js/75.21af2b7e.js"><link rel="prefetch" href="/notes-page/assets/js/76.2a801727.js"><link rel="prefetch" href="/notes-page/assets/js/77.ba6247ab.js"><link rel="prefetch" href="/notes-page/assets/js/78.ce9e998f.js"><link rel="prefetch" href="/notes-page/assets/js/79.4887762f.js"><link rel="prefetch" href="/notes-page/assets/js/80.b05330db.js"><link rel="prefetch" href="/notes-page/assets/js/81.bfd94f31.js"><link rel="prefetch" href="/notes-page/assets/js/82.bcb6a8a7.js"><link rel="prefetch" href="/notes-page/assets/js/83.95a610a2.js"><link rel="prefetch" href="/notes-page/assets/js/84.ba329fe9.js"><link rel="prefetch" href="/notes-page/assets/js/85.d573f3c2.js"><link rel="prefetch" href="/notes-page/assets/js/86.4bfc93b2.js"><link rel="prefetch" href="/notes-page/assets/js/87.d7efdcba.js"><link rel="prefetch" href="/notes-page/assets/js/88.9953794c.js"><link rel="prefetch" href="/notes-page/assets/js/89.1b1483ea.js"><link rel="prefetch" href="/notes-page/assets/js/9.e35e8ba0.js"><link rel="prefetch" href="/notes-page/assets/js/90.734ae923.js"><link rel="prefetch" href="/notes-page/assets/js/91.3e1c0747.js"><link rel="prefetch" href="/notes-page/assets/js/92.7119ff47.js"><link rel="prefetch" href="/notes-page/assets/js/93.73d5f435.js"><link rel="prefetch" href="/notes-page/assets/js/94.13e300ce.js"><link rel="prefetch" href="/notes-page/assets/js/95.c34b2cea.js"><link rel="prefetch" href="/notes-page/assets/js/96.97324a67.js"><link rel="prefetch" href="/notes-page/assets/js/97.3aef1522.js"><link rel="prefetch" href="/notes-page/assets/js/98.c31d1504.js"><link rel="prefetch" href="/notes-page/assets/js/99.639a7345.js"><link rel="prefetch" href="/notes-page/assets/js/vendors~docsearch.c5d17f3f.js"><link rel="prefetch" href="/notes-page/assets/js/vendors~photo-swipe.b41b272e.js"><link rel="prefetch" href="/notes-page/assets/js/vendors~search-page.4c6aecd1.js">
    <link rel="stylesheet" href="/notes-page/assets/css/0.styles.ee344319.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notes-page/" class="home-link router-link-active"><!----> <span class="site-name">大前端 - 前端高级进阶</span></a> <div class="links"><div id="docsearch"></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>社区PC</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-page/project/community-pc/" class="sidebar-link">PC</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>社区管理后台</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-page/project/community-admin/" class="sidebar-link">管理后台</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>社区WebApp</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-page/project/community-webapp/" class="sidebar-link">webapp</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>小程序</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-page/project/community-miniapp/" aria-current="page" class="sidebar-link">uniapp介绍</a></li><li><a href="/notes-page/project/community-miniapp/01-搭建开发环境.html" class="sidebar-link">搭建开发环境</a></li><li><a href="/notes-page/project/community-miniapp/02-首页模块.html" class="sidebar-link">首页模块</a></li><li><a href="/notes-page/project/community-miniapp/03-登录鉴权.html" class="sidebar-link">小程序鉴权登录</a></li><li><a href="/notes-page/project/community-miniapp/04-消息&amp;热门&amp;个人中心.html" class="sidebar-link">消息&amp;热门&amp;个人中心</a></li><li><a href="/notes-page/project/community-miniapp/05-RefreshToken机制.html" class="sidebar-link">RefreshToken机制</a></li><li><a href="/notes-page/project/community-miniapp/06-文章详情.html" class="sidebar-link">文章详情</a></li><li><a href="/notes-page/project/community-miniapp/07-安全域名相关.html" class="sidebar-link">安全域名相关</a></li><li><a href="/notes-page/project/community-miniapp/08-订阅消息.html" class="active sidebar-link">订阅消息</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/08-订阅消息.html#介绍" class="sidebar-link">介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/08-订阅消息.html#消息类型" class="sidebar-link">消息类型</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/08-订阅消息.html#使用步骤" class="sidebar-link">使用步骤</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/08-订阅消息.html#封装订阅消息工具js" class="sidebar-link">封装订阅消息工具js</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/08-订阅消息.html#前端主动订阅" class="sidebar-link">前端主动订阅</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/08-订阅消息.html#订阅消息模板api" class="sidebar-link">订阅消息模板API</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/08-订阅消息.html#维护accesstoken" class="sidebar-link">维护accessToken</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/08-订阅消息.html#后台发送订阅消息" class="sidebar-link">后台发送订阅消息</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/08-订阅消息.html#https调用接口说明" class="sidebar-link">HTTPS调用接口说明</a></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/08-订阅消息.html#创建发送消息工具js" class="sidebar-link">创建发送消息工具js</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes-page/project/community-miniapp/08-订阅消息.html#前后端联调" class="sidebar-link">前后端联调</a></li></ul></li><li><a href="/notes-page/project/community-miniapp/09-内容安全.html" class="sidebar-link">内容安全</a></li><li><a href="/notes-page/project/community-miniapp/10-发贴&amp;评论功能.html" class="sidebar-link">发贴评论功能</a></li><li><a href="/notes-page/project/community-miniapp/11-发布上线.html" class="sidebar-link">发布上线</a></li><li><a href="/notes-page/project/community-miniapp/12-支付专题.html" class="sidebar-link">支付专题</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Flutter 2.0</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-page/project/community-flutter/" class="sidebar-link">Flutter</a></li><li><a href="/notes-page/project/community-flutter/01-风格指南.html" class="sidebar-link">风格指南</a></li><li><a href="/notes-page/project/community-flutter/02-Flutter入门.html" class="sidebar-link">Flutter入门案例</a></li><li><a href="/notes-page/project/community-flutter/03-异步编程思想.html" class="sidebar-link">异步编程思想</a></li><li><a href="/notes-page/project/community-flutter/04-状态管理.html" class="sidebar-link">状态管理概览</a></li><li><a href="/notes-page/project/community-flutter/05-状态管理-redux.html" class="sidebar-link">状态管理方案-Redux</a></li><li><a href="/notes-page/project/community-flutter/06-状态管理-scoped_model.html" class="sidebar-link">状态管理方案-ScopedModel</a></li><li><a href="/notes-page/project/community-flutter/07-状态管理-bloc.html" class="sidebar-link">状态管理方案-Bloc</a></li><li><a href="/notes-page/project/community-flutter/08-获取验证码.html" class="sidebar-link">获取验证码</a></li><li><a href="/notes-page/project/community-flutter/09-封装请求.html" class="sidebar-link">封装请求</a></li><li><a href="/notes-page/project/community-flutter/10-网络测试.html" class="sidebar-link">网络调试</a></li><li><a href="/notes-page/project/community-flutter/11-创建短信接口服务.html" class="sidebar-link">创建发送短信验证码服务</a></li><li><a href="/notes-page/project/community-flutter/12-序列化.html" class="sidebar-link">序列化</a></li><li><a href="/notes-page/project/community-flutter/13-自定义toast组件.html" class="sidebar-link">自定义toast组件</a></li><li><a href="/notes-page/project/community-flutter/14-优化短信验证码逻辑.html" class="sidebar-link">优化短信验证码逻辑</a></li><li><a href="/notes-page/project/community-flutter/15-数据持久化-getstorage.html" class="sidebar-link">数据持久化-GetStorage</a></li><li><a href="/notes-page/project/community-flutter/16-数据持久化-sqflite.html" class="sidebar-link">数据持久化-Sqflite</a></li><li><a href="/notes-page/project/community-flutter/17-路由.html" class="sidebar-link">路由</a></li><li><a href="/notes-page/project/community-flutter/18-集成方案&amp;消息&amp;适配.html" class="sidebar-link">集成方案&amp;消息&amp;适配</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Electron桌面端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-page/project/community-electron/" class="sidebar-link">electron</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>React世界</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes-page/project/react/" class="sidebar-link">React项目</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="订阅消息"><a href="#订阅消息" class="header-anchor">#</a> 订阅消息</h1> <h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <p>消息能力是小程序能力中的重要组成，我们为开发者提供了订阅消息能力，以便实现服务的闭环和更优的体验。</p> <ul><li>订阅消息推送位置：服务通知</li> <li>订阅消息下发条件：用户自主订阅</li> <li>订阅消息卡片跳转能力：点击查看详情可跳转至该小程序的页面</li></ul> <p><img src="/notes-page/assets/img/request-subscribe-message.3851318e.3851318e.jpg" alt="intro"></p> <h3 id="消息类型"><a href="#消息类型" class="header-anchor">#</a> 消息类型</h3> <p><strong>1. 一次性订阅消息</strong></p> <p>一次性订阅消息用于解决用户使用小程序后，后续服务环节的通知问题。用户自主订阅后，开发者可<strong>不限时间</strong>地下发<strong>一条对应的服务消息</strong>；每条消息可单独订阅或退订。</p> <p><strong>2. 长期订阅消息</strong></p> <p>一次性订阅消息可满足小程序的大部分服务场景需求，但线下公共服务领域存在一次性订阅无法满足的场景，如航班延误，需根据航班实时动态来多次发送消息提醒。为便于服务，我们提供了长期性订阅消息，用户订阅一次后，开发者可长期下发多条消息。</p> <p>目前长期性订阅消息仅向政务民生、医疗、交通、金融、教育等线下公共服务开放，后期将逐步支持到其他线下公共服务业务。</p> <h3 id="使用步骤"><a href="#使用步骤" class="header-anchor">#</a> 使用步骤</h3> <ul><li><p>步骤一：获取模板 ID</p> <p>在微信公众平台手动配置获取模板 ID：
登录 <a href="https://mp.weixin.qq.com/" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 获取模板，如果没有合适的模板，可以申请添加新模板，审核通过后可使用。</p> <p><img src="https://res.wx.qq.com/wxdoc/dist/assets/img/subscribe-message.b562750a.jpg" alt="intro"></p></li> <li><p>步骤二：获取下发权限</p> <p>详见小程序端消息订阅接口 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/subscribe-message/wx.requestSubscribeMessage.html" target="_blank" rel="noopener noreferrer">wx.requestSubscribeMessage<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>步骤三：调用接口下发订阅消息</p> <p>详见服务端消息发送接口 <a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html" target="_blank" rel="noopener noreferrer">subscribeMessage.send<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>注意事项：用户勾选 “总是保持以上选择，不再询问” 之后，下次订阅调用 wx.requestSubscribeMessage 不会弹窗，保持之前的选择，修改选择需要打开小程序设置进行修改。</p></blockquote></li></ul> <h2 id="封装订阅消息工具js"><a href="#封装订阅消息工具js" class="header-anchor">#</a> 封装订阅消息工具js</h2> <p>作用：</p> <ul><li>发起订阅请求；</li> <li>判断用户是否开启了通知；</li> <li>提示未开启通知的用户，并跳转设置页面；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> mute <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  uni<span class="token punctuation">.</span><span class="token function">requestSubscribeMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">tmplIds</span><span class="token operator">:</span> arr<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">3</span> <span class="token operator">?</span> arr<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">:</span> arr<span class="token punctuation">,</span>
    <span class="token comment">// 在调试工具中，无论订阅成功还是取消，都可以在complete取到状态</span>
    <span class="token comment">// 调试工具中，无法直接测试关闭订阅的状态</span>
    <span class="token comment">// 在真机上，可以获取用户拒绝订阅的状态</span>
    <span class="token comment">// 而且在complete部分可以获取到success/fail的回调内容</span>
    <span class="token function-variable function">complete</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 2.1 如果用户未订阅，并未拒绝，正常发起订阅</span>
      <span class="token comment">// 2.2 如果用户拒绝了订阅，需要给用户一个轻提示 -&gt; 手动打开订阅消息的</span>
      <span class="token comment">// wx.openSetting</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'reject'</span><span class="token punctuation">)</span> <span class="token operator">||</span> res<span class="token punctuation">.</span>errCode <span class="token operator">===</span> <span class="token number">20004</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        uni<span class="token punctuation">.</span><span class="token function">showModal</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'您关闭了订阅通知'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'需要打开设置进行手动设置吗？'</span><span class="token punctuation">,</span>
          <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>confirm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              uni<span class="token punctuation">.</span><span class="token function">openSetting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>cancel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'您取消了订阅'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token number">2000</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>arr<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'reject'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">!</span>mute <span class="token operator">&amp;&amp;</span> uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'您已经订阅了该消息'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token number">1500</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>errCode <span class="token operator">===</span> <span class="token number">10002</span> <span class="token operator">||</span> res<span class="token punctuation">.</span>errCode <span class="token operator">===</span> <span class="token number">10003</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'网络问题订阅失败，请重新订阅'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token number">1500</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 其他的逻辑 https://developers.weixin.qq.com/miniprogram/dev/api/open-api/subscribe-message/wx.requestSubscribeMessage.html</span>
      <span class="token punctuation">}</span>
      cb <span class="token operator">&amp;&amp;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="前端主动订阅"><a href="#前端主动订阅" class="header-anchor">#</a> 前端主动订阅</h2> <p>在App.vue中添加判断用户订阅逻辑：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">onLaunch</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.warn('当前组件仅支持 uni_modules 目录结构 ，请升级 HBuilderX 到 3.1.0 版本以上！')</span>
    <span class="token comment">// console.log('App Launch')</span>
    uni<span class="token punctuation">.</span><span class="token function">getSetting</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">withSubscriptions</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>subscriptionsSetting <span class="token operator">=</span> res<span class="token punctuation">.</span>subscriptionsSetting
        <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span>
          <span class="token string">'S7zrpjN9Kq05-4ZG_nlTAYxnARMLWlSW09h54A2JCZo'</span><span class="token punctuation">,</span>
          <span class="token string">'ANN2-LhDgrhdFjs7jHOLdTnaxWpQU1LqS3kDIMF9GDs'</span><span class="token punctuation">,</span>
          <span class="token string">'FSQZganmBgaRRoNNlelQ1Qm2u4gx6pVSt69EJfkLbPA'</span><span class="token punctuation">,</span>
          <span class="token string">'g9FFU43_deHRuez-2FcrASorTSITsJJPYx-GhzvHEIU'</span>
        <span class="token punctuation">]</span>
        <span class="token comment">// 1. 获取用户已经订阅的消息</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">itemSettings</span><span class="token operator">:</span> keys<span class="token punctuation">,</span> mainSwitch <span class="token punctuation">}</span> <span class="token operator">=</span> res<span class="token punctuation">.</span>subscriptionsSetting
        <span class="token comment">// 相当于用户未打开订阅开关</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mainSwitch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 用户开启订阅消息 -&gt; 如果未设置任何消息</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>tmplIds <span class="token operator">=</span> arr
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 用户开启了订阅消息 -&gt; 已经有部分订阅 -&gt; reject, accept</span>
          <span class="token keyword">const</span> keysArr <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span>
          app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>tmplIds <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> keysArr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">onShow</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'App Show'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">onHide</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'App Hide'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在需要订阅的位置，加入订阅逻辑，比如在个人中心中，点击去登录时：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> sub <span class="token keyword">from</span> <span class="token string">'@/common/utils/subscribe'</span>

<span class="token comment">// ...</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> tmplIds <span class="token operator">=</span> app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>tmplIds <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token function">sub</span><span class="token punctuation">(</span>tmplIds<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isLogin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uni<span class="token punctuation">.</span><span class="token function">navigateTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'/subcom-pkg/auth/auth'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>注意：订阅消息一次最多只可以订阅3条，所以需要加入一个splice方法截断未订阅的消息。</p> <p>也可以自己在指定的业务部分，给<code>sub</code>方法，传递指定的模板ID。</p></blockquote> <h2 id="订阅消息模板api"><a href="#订阅消息模板api" class="header-anchor">#</a> 订阅消息模板API</h2> <p>应用场景：</p> <ul><li>后台控制哪些消息可以被订阅；</li> <li>当模板消息的id发生了变化时，如果保证订阅的准确性；</li></ul> <p>前端请求模板API：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获取模板id</span>
<span class="token keyword">const</span> <span class="token function-variable function">getSubIds</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/public/subids'</span><span class="token punctuation">)</span>
</code></pre></div><p>调整App.vue中的模板IDs的判断逻辑，处理：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 模板ID</span>
<span class="token comment">// 改装成一个API接口 -&gt; key:value -&gt; value, key -&gt; 业务场景</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> code<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$u<span class="token punctuation">.</span>api<span class="token punctuation">.</span><span class="token function">getSubIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> arr
<span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// {key: value, key1: value1} =&gt; [value, value1]</span>
  arr <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">o</span> <span class="token operator">=&gt;</span> o<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 默认的前端模板数据</span>
  arr <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'S7zrpjN9Kq05-4ZG_nlTAYxnARMLWlSW09h54A2JCZo'</span><span class="token punctuation">,</span>
    <span class="token string">'ANN2-LhDgrhdFjs7jHOLdTnaxWpQU1LqS3kDIMF9GDs'</span><span class="token punctuation">,</span>
    <span class="token string">'FSQZganmBgaRRoNNlelQ1Qm2u4gx6pVSt69EJfkLbPA'</span><span class="token punctuation">,</span>
    <span class="token string">'g9FFU43_deHRuez-2FcrASorTSITsJJPYx-GhzvHEIU'</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>后端创建路由与接口：</p> <p>路由：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获取微信模板id</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/subids'</span><span class="token punctuation">,</span> publicController<span class="token punctuation">.</span>getSubIds<span class="token punctuation">)</span>
</code></pre></div><p>接口：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">getSubIds</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> config<span class="token punctuation">.</span>subIds
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="维护accesstoken"><a href="#维护accesstoken" class="header-anchor">#</a> 维护accessToken</h2> <p>后端发送订阅消息需要accessToken：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">POST</span> <span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>api<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>qq<span class="token punctuation">.</span>com<span class="token operator">/</span>cgi<span class="token operator">-</span>bin<span class="token operator">/</span>message<span class="token operator">/</span>subscribe<span class="token operator">/</span>send<span class="token operator">?</span>access_token<span class="token operator">=</span><span class="token constant">ACCESS_TOKEN</span>
</code></pre></div><p>见官方文档：<a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html" target="_blank" rel="noopener noreferrer">链接<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>由于acessToken的有效时间是2小时，而且每天微信请求的限制为2000次（<a href="https://developers.weixin.qq.com/doc/offiaccount/Message_Management/API_Call_Limits.html" target="_blank" rel="noopener noreferrer">链接<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>），如下图：</p> <img src="/notes-page/assets/img/image-20210812102933432.90192975.png" alt="image-20210812102933432" style="zoom:67%;"> <p>所以，需要自己定时维护accessToken：</p> <ul><li><p>创建<code>wxGetAccessToken</code>方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> log4js <span class="token keyword">from</span> <span class="token string">'@/config/Log4j'</span>
<span class="token keyword">const</span> logger <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getValue<span class="token punctuation">,</span> setValue <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/config/RedisConfig'</span>

<span class="token comment">// flag 强制刷新，默认false - 不强制刷新</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">wxGetAccessToken</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">flag <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET</span>
  <span class="token comment">// 1.判断redis中是否有accessToken</span>
  <span class="token comment">// 2.有 &amp; flag -&gt; 则直接返回</span>
  <span class="token comment">// 3.没有 -&gt; 请求新的token</span>
  <span class="token keyword">let</span> accessToken <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">'accessToken'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>accessToken <span class="token operator">||</span> flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> instance<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>AppID<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;secret=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>AppSecret<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token comment">// console.log('🚀 ~ file: WxUtils.js ~ line 60 ~ wxGetAccessToken ~ result', result)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">'accessToken'</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>access_token<span class="token punctuation">,</span> result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>expires_in<span class="token punctuation">)</span>
        accessToken <span class="token operator">=</span> result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>access_token
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>errcode <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>errmsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">wxGetAccessToken error</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>errcode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>errmsg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">wxGetAccessToken error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> accessToken
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>安装依赖<code>npm i cron</code></p></li> <li><p>配置定时任务：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 每隔7200秒执行一次 刷新accessToken</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CronJob <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'cron'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> wxGetAccessToken <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./WxUtils'</span>

<span class="token comment">// Seconds: 0-59</span>
<span class="token comment">// Minutes: 0-59</span>
<span class="token comment">// Hours: 0-23</span>
<span class="token comment">// Day of Month: 1-31</span>
<span class="token comment">// Months: 0-11 (Jan-Dec)</span>
<span class="token comment">// Day of Week: 0-6 (Sun-Sat)</span>

<span class="token keyword">const</span> job <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CronJob</span><span class="token punctuation">(</span><span class="token string">'* * */1 * * *'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">wxGetAccessToken</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

job<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>在入口文件处理，添加该文件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token string">'./common/Cron'</span>
</code></pre></div></li></ul> <p><strong>常见问题，如果不小心accessToken请求超限怎么办：</strong></p> <p><img src="/notes-page/assets/img/0.a36c9ed1.png" alt="img"></p> <h2 id="后台发送订阅消息"><a href="#后台发送订阅消息" class="header-anchor">#</a> 后台发送订阅消息</h2> <p>发送订阅消息：<a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>调用方式：</p> <ul><li><a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html#method-http" target="_blank" rel="noopener noreferrer">HTTPS 调用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html#method-cloud" target="_blank" rel="noopener noreferrer">云调用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="https调用接口说明"><a href="#https调用接口说明" class="header-anchor">#</a> HTTPS调用接口说明</h3> <div class="language- extra-class"><pre class="language-text"><code>POST https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=ACCESS_TOKEN
</code></pre></div><p><strong>请求参数：</strong></p> <table><thead><tr><th style="text-align:left;">属性</th> <th style="text-align:left;">类型</th> <th style="text-align:left;">默认值</th> <th style="text-align:left;">必填</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">access_token / cloudbase_access_token</td> <td style="text-align:left;">string</td> <td style="text-align:left;"></td> <td style="text-align:left;">是</td> <td style="text-align:left;"><a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/access-token/auth.getAccessToken.html" target="_blank" rel="noopener noreferrer">接口调用凭证<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td style="text-align:left;">touser</td> <td style="text-align:left;">string</td> <td style="text-align:left;"></td> <td style="text-align:left;">是</td> <td style="text-align:left;">接收者（用户）的 openid</td></tr> <tr><td style="text-align:left;">template_id</td> <td style="text-align:left;">string</td> <td style="text-align:left;"></td> <td style="text-align:left;">是</td> <td style="text-align:left;">所需下发的订阅模板id</td></tr> <tr><td style="text-align:left;">page</td> <td style="text-align:left;">string</td> <td style="text-align:left;"></td> <td style="text-align:left;">否</td> <td style="text-align:left;">点击模板卡片后的跳转页面，仅限本小程序内的页面。支持带参数,（示例index?foo=bar）。该字段不填则模板无跳转。</td></tr> <tr><td style="text-align:left;">data</td> <td style="text-align:left;">Object</td> <td style="text-align:left;"></td> <td style="text-align:left;">是</td> <td style="text-align:left;">模板内容，格式形如 { &quot;key1&quot;: { &quot;value&quot;: any }, &quot;key2&quot;: { &quot;value&quot;: any } }</td></tr> <tr><td style="text-align:left;">miniprogram_state</td> <td style="text-align:left;">string</td> <td style="text-align:left;"></td> <td style="text-align:left;">否</td> <td style="text-align:left;">跳转小程序类型：developer为开发版；trial为体验版；formal为正式版；默认为正式版</td></tr> <tr><td style="text-align:left;">lang</td> <td style="text-align:left;">string</td> <td style="text-align:left;"></td> <td style="text-align:left;">否</td> <td style="text-align:left;">进入小程序查看”的语言类型，支持zh_CN(简体中文)、en_US(英文)、zh_HK(繁体中文)、zh_TW(繁体中文)，默认为zh_CN</td></tr></tbody></table> <p><strong>说明一下关于<code>data</code>：</strong></p> <p>例如，模板的内容为</p> <div class="language-text extra-class"><pre class="language-text"><code>姓名: {{name01.DATA}}
金额: {{amount01.DATA}}
行程: {{thing01.DATA}}
日期: {{date01.DATA}}
</code></pre></div><p>则对应的json为</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;touser&quot;</span><span class="token operator">:</span> <span class="token string">&quot;OPENID&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;template_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;TEMPLATE_ID&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;page&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;name01&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;某某&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;amount01&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;￥100&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;thing01&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;广州至北京&quot;</span>
      <span class="token punctuation">}</span> <span class="token punctuation">,</span>
      <span class="token property">&quot;date01&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2018-01-01&quot;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里的data有内容限制（举例如下表），更多查看官方文档详情：</p> <table><thead><tr><th style="text-align:left;">参数类别</th> <th style="text-align:left;">参数说明</th> <th style="text-align:left;">参数值限制</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">thing.DATA</td> <td style="text-align:left;">事物</td> <td style="text-align:left;">20个以内字符</td> <td style="text-align:left;">可汉字、数字、字母或符号组合</td></tr> <tr><td style="text-align:left;">number.DATA</td> <td style="text-align:left;">数字</td> <td style="text-align:left;">32位以内数字</td> <td style="text-align:left;">只能数字，可带小数</td></tr> <tr><td style="text-align:left;">letter.DATA</td> <td style="text-align:left;">字母</td> <td style="text-align:left;">32位以内字母</td> <td style="text-align:left;">只能字母</td></tr> <tr><td style="text-align:left;">symbol.DATA</td> <td style="text-align:left;">符号</td> <td style="text-align:left;">5位以内符号</td> <td style="text-align:left;">只能符号</td></tr> <tr><td style="text-align:left;">character_string.DATA</td> <td style="text-align:left;">字符串</td> <td style="text-align:left;">32位以内数字、字母或符号</td> <td style="text-align:left;">可数字、字母或符号组合</td></tr> <tr><td style="text-align:left;">time.DATA</td> <td style="text-align:left;">时间</td> <td style="text-align:left;">24小时制时间格式（支持+年月日），支持填时间段，两个时间点之间用“~”符号连接</td> <td style="text-align:left;">例如：15:01，或：2019年10月1日 15:01</td></tr> <tr><td style="text-align:left;">date.DATA</td> <td style="text-align:left;">日期</td> <td style="text-align:left;">年月日格式（支持+24小时制时间），支持填时间段，两个时间点之间用“~”符号连接</td> <td style="text-align:left;">例如：2019年10月1日，或：2019年10月1日 15:01</td></tr> <tr><td style="text-align:left;">amount.DATA</td> <td style="text-align:left;">金额</td> <td style="text-align:left;">1个币种符号+10位以内纯数字，可带小数，结尾可带“元”</td> <td style="text-align:left;">可带小数</td></tr> <tr><td style="text-align:left;">phone_number.DATA</td> <td style="text-align:left;">电话</td> <td style="text-align:left;">17位以内，数字、符号</td> <td style="text-align:left;">电话号码，例：+86-0766-66888866</td></tr> <tr><td style="text-align:left;">car_number.DATA</td> <td style="text-align:left;">车牌</td> <td style="text-align:left;">8位以内，第一位与最后一位可为汉字，其余为字母或数字</td> <td style="text-align:left;">车牌号码：粤A8Z888挂</td></tr> <tr><td style="text-align:left;">name.DATA</td> <td style="text-align:left;">姓名</td> <td style="text-align:left;">10个以内纯汉字或20个以内纯字母或符号</td> <td style="text-align:left;">中文名10个汉字内；纯英文名20个字母内；中文和字母混合按中文名算，10个字内</td></tr> <tr><td style="text-align:left;">phrase.DATA</td> <td style="text-align:left;">汉字</td> <td style="text-align:left;">5个以内汉字</td> <td style="text-align:left;">5个以内纯汉字，例如：配送中</td></tr></tbody></table> <p>返回的 JSON 数据包</p> <table><thead><tr><th style="text-align:left;">属性</th> <th style="text-align:left;">类型</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">errcode</td> <td style="text-align:left;">number</td> <td style="text-align:left;">错误码</td></tr> <tr><td style="text-align:left;">errmsg</td> <td style="text-align:left;">string</td> <td style="text-align:left;">错误信息</td></tr></tbody></table> <p><strong>errcode 的合法值</strong></p> <table><thead><tr><th style="text-align:left;">值</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">40003</td> <td style="text-align:left;">touser字段openid为空或者不正确</td></tr> <tr><td style="text-align:left;">40037</td> <td style="text-align:left;">订阅模板id为空不正确</td></tr> <tr><td style="text-align:left;">43101</td> <td style="text-align:left;">用户拒绝接受消息，如果用户之前曾经订阅过，则表示用户取消了订阅关系</td></tr> <tr><td style="text-align:left;">47003</td> <td style="text-align:left;">模板参数不准确，可能为空或者不满足规则，errmsg会提示具体是哪个字段出错</td></tr> <tr><td style="text-align:left;">41030</td> <td style="text-align:left;">page路径不正确，需要保证在现网版本小程序中存在，与app.json保持一致</td></tr></tbody></table> <h3 id="创建发送消息工具js"><a href="#创建发送消息工具js" class="header-anchor">#</a> 创建发送消息工具js</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">wxSendMessage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// POST https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=ACCESS_TOKEN</span>
  <span class="token keyword">let</span> accessToken <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">wxGetAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> instance<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>accessToken<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token keyword">return</span> data
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">wxSendMessage error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>举例：</p> <p>在用户登录之后，发送订阅消息通知：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 推送消息</span>
<span class="token comment">// 字段限制：https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html</span>
<span class="token keyword">const</span> notify <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">wxSendMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">touser</span><span class="token operator">:</span> tmpUser<span class="token punctuation">.</span>openid<span class="token punctuation">,</span>
  <span class="token literal-property property">template_id</span><span class="token operator">:</span> <span class="token string">'FSQZganmBgaRRoNNlelQ1Qm2u4gx6pVSt69EJfkLbPA'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">phrase1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'登录安全'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">date2</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYY年MM月DD HH:mm'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">thing4</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'通过微信授权登录成功，请注意信息安全'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">miniprogram_state</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span> <span class="token operator">?</span> <span class="token string">'developer'</span> <span class="token operator">:</span> <span class="token string">'formal'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="前后端联调"><a href="#前后端联调" class="header-anchor">#</a> 前后端联调</h2> <p>联调需要注意的点：</p> <ul><li>设置<code>miniprogram_state</code>属性；</li> <li>使用真机进行调试 -&gt; 配置局域网的访问的IP -&gt; 让电脑与手机处于同一个网段；</li> <li>检查发送订阅消息的数据格式、模板id、用户openid数据是否正确；</li> <li>使用单步调试：发送订阅消息的接口，查看返回的errcode如果是0，说明发送成功；如果失败，则根据errcode来调整程序代码；</li></ul> <img src="/notes-page/assets/img/image-20210812111502555.6ac23418.png" alt="image-20210812111502555" style="zoom:67%;"></div> <!----> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/notes-page/project/community-miniapp/07-安全域名相关.html" class="prev">
        安全域名相关
      </a></span> <span class="next"><a href="/notes-page/project/community-miniapp/09-内容安全.html">
        内容安全
      </a>
      →
    </span></p></div>  <div class="el-dialog__wrapper" style="display:none;"><div role="dialog" aria-modal="true" aria-label="dialog" class="el-dialog" style="margin-top:15vh;width:420px;"><div class="el-dialog__header"><span class="el-dialog__title"></span><button type="button" aria-label="Close" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button></div><!----><div class="el-dialog__footer"><span class="dialog-footer"><button type="button" class="el-button el-button--default"><!----><!----><span>取 消</span></button> <button type="button" class="el-button el-button--primary"><!----><!----><span>确 定</span></button></span></div></div></div></main> <!----></div><div class="global-ui"><!----><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button class="pswp__button pswp__button--close"></button> <button class="pswp__button pswp__button--share"></button> <button class="pswp__button pswp__button--fs"></button> <button class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button class="pswp__button pswp__button--arrow--left"></button> <button class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/notes-page/assets/js/app.48cb01bf.js" defer></script><script src="/notes-page/assets/js/8.c8491ce8.js" defer></script><script src="/notes-page/assets/js/47.98971016.js" defer></script>
  </body>
</html>
