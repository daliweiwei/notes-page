(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{1141:function(t,s,a){"use strict";a.r(s);var n=a(30),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey},scopedSlots:t._u([{key:"auth",fn:function(){return[n("h3",{attrs:{id:"课程福利nginx配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#课程福利nginx配置"}},[t._v("#")]),t._v(" 课程福利nginx配置")]),t._v(" "),n("p",[t._v("nginx的配置文件地址："),n("a",{attrs:{href:"https://gist.github.com/toimc/24df7ea1adab57ee9560062ae9905c2a",target:"_blank",rel:"noopener noreferrer"}},[t._v("github"),n("OutboundLink")],1)]),t._v(" "),n("h3",{attrs:{id:"场景一-配置博客应用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#场景一-配置博客应用"}},[t._v("#")]),t._v(" 场景一：配置博客应用")]),t._v(" "),n("p",[t._v("添加宿主机的docker目录映射：")]),t._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"3"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("web")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("latest\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"some-nginx"')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/nginx/nginx.conf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/etc/nginx/nginx.conf\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/nginx/conf.d"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/etc/nginx/conf.d\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/keys"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/home/keys\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# blog")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/blog"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/www\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"80:80"')]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"443:443"')]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker network create https")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("default")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("external")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https\n")])])]),n("p",[t._v("nginx的配置文件 "),n("code",[t._v("conf.d/vhost.conf")]),t._v("：")]),t._v(" "),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# listen on HTTP2/SSL")]),t._v("\nserver "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  listen "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(" ssl http2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  server_name www.wayearn.com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ssl certs from letsencrypt")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ssl on;")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 这里要注意目录是docker里面的目录，所以建议大家把容器里面的目录与宿主机的目录映射一致")]),t._v("\n  ssl_certificate /home/keys/certs.pem"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_certificate_key /home/keys/key.pem"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# dhparam.pem")]),t._v("\n  ssl_dhparam /home/keys/dhparam.pem"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  ssl_session_cache shared:SSL:50m"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_session_timeout 30m"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_session_tickets off"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  ssl_protocols TLSv1 TLSv1.1 TLSv1.2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ciphers chosen for forward secrecy and compatibility")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# http://blog.ivanristic.com/2013/08/configuring-apache-nginx-and-openssl-for-forward-secrecy.html")]),t._v("\n  ssl_ciphers "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  ssl_prefer_server_ciphers on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  add_header Strict-Transport-Security "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"max-age=31536000; includeSubdomains; preload"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  location / "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    root /var/www/"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    index index.html"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_set_header Host "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$host")]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$server_port")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_set_header X-Real-IP "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_addr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_set_header X-Forwarded-For "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$proxy_add_x_forwarded_for")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_set_header X-Forwarded-Proto "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$scheme")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# redirect HTTP and handle let's encrypt requests")]),t._v("\nserver "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  listen "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  server_name www.wayearn.com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  location / "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("301")]),t._v(" https://"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$host")]),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$request_uri")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("检测ssl网站的评级 myssl.com：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(881),alt:"image-20210810220929142"}})]),t._v(" "),n("h3",{attrs:{id:"场景二-配置小程序api接口"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#场景二-配置小程序api接口"}},[t._v("#")]),t._v(" 场景二：配置小程序API接口")]),t._v(" "),n("p",[t._v("步骤：")]),t._v(" "),n("ul",[n("li",[t._v("api -> 线上 -> nginx进行代理 ；")]),t._v(" "),n("li",[t._v("api部署到线上的服务器；")]),t._v(" "),n("li",[t._v("api服务可以被nginx访问到；")]),t._v(" "),n("li",[t._v("域名 + https形式去访问 -> 提供api服务\n"),n("ul",[n("li",[t._v("配置nginx的vhost配置 + 配置域名解析dns")]),t._v(" "),n("li",[t._v("wx.yourdomain.com -> 指向服务器的IP")]),t._v(" "),n("li",[t._v("重启nginx容器让vhost的配置生效 -> 测试服务")])])])]),t._v(" "),n("p",[t._v("小程序的docker-compose文件：")]),t._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"3"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("web")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("build")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("context")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" .\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dockerfile")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Dockerfile\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("args")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Version")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("Version"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" api_online"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("$"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("tag"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" api_online\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# env_file: .env")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_USER=$DB_USER\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_PASS=$DB_PASS\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_HOST=$DB_HOST\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_PORT=$DB_PORT\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_NAME=$DB_NAME\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" REDIS_HOST=$REDIS_HOST\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" REDIS_PORT=$REDIS_PORT\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" REDIS_PASS=$REDIS_PASS\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${PORT}:3000"')]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${WS_PORT}:3001"')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/imooc/online"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/app/public\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 关键就是这里，配置API项目的网络，连接到https网络")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 然后，使用vhost配置，让Nginx进行代理")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("default")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("external")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https\n")])])]),n("p",[t._v("可选方案：提供Mongo、redis环境的"),n("code",[t._v("docker-compose.yml")]),t._v("文件：")]),t._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"3"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("web")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("build")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("context")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" .\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dockerfile")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Dockerfile\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("args")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Version")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" api_online"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" api_online\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# env_file: .env")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_USER=toimc\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_PASS=long_random_pass_mongo\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_HOST=mongo\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_PORT=27017\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_NAME=community\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" REDIS_HOST=redis\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" REDIS_PORT=6379\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" REDIS_PASS=long_random_pass_redis\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10030:3000"')]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10031:3001"')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/imooc/online"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/app/public\n\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mongo")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mongo\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mongodb"')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/imooc/db"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/data/db\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/imooc/db/initdb.d"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/docker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("entrypoint"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("initdb.d/\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# .sh & .js")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"27017:27017"')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("MONGO_INITDB_ROOT_USERNAME")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" root\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("MONGO_INITDB_ROOT_PASSWORD")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" example\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("MONGO_INITDB_DATABASE")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" testdb\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("MONGO_INITDB_USERNAME")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" toimc\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("MONGO_INITDB_PASSWORD")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" long_random_pass_mongo\n\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("redis")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" redis\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"redis"')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"6379:6379"')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("command")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("requirepass long_random_pass_redis\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("default")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("external")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https\n")])])]),n("p",[t._v("MongoDB的初始化文件"),n("code",[t._v("init.d/mongo-init.sh")]),t._v("文件：")]),t._v(" "),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[t._v("mongo -- "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$MONGO_INITDB_DATABASE")]),t._v('"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF\nvar rootUser = '"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$MONGO_INITDB_ROOT_USERNAME")]),t._v("';\nvar rootPassword = '"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$MONGO_INITDB_ROOT_PASSWORD")]),t._v("';\nvar initDB = '"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$MONGO_INITDB_DATABASE")]),t._v("'\nvar admin = db.getSiblingDB(initDB);\nadmin.auth(rootUser, rootPassword);\n\nvar user = '"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$MONGO_INITDB_USERNAME")]),t._v("';\nvar passwd = '"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$MONGO_INITDB_PASSWORD")]),t._v('\';\ndb.createUser({ user: user, pwd: passwd, roles: ["dbOwner"] });\nEOF')]),t._v("\n")])])]),n("p",[t._v("手动部署API服务：")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("使用docker命令进行docker镜像的构建")])]),t._v(" "),n("li",[n("p",[t._v("推送镜像或者使用手动方式导入镜像")]),t._v(" "),n("p",[t._v("保存(Save)")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v(" # 保留原镜像的名称和标签\n docker save <IMAGE NAME>:<IMAGE TAG> > save.tar\n\n # 不保留原镜像的基本信息,加载load后需执行tag命令重命名none镜像\n docker save <IMAGE ID> > save.tar \n")])])]),n("p",[t._v("示例:")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("docker save elasticsearch:7.1.1 > elasticsearch-7.1.1.tar\n# 或\ndocker save b0cb1543380d > elasticsearch-7.1.1.tar\n")])])]),n("p",[t._v("加载(Load)")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("docker load < save.tar\n")])])]),n("p",[t._v("示列:")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("docker load < elasticsearch-7.1.1.tar\n")])])])]),t._v(" "),n("li",[n("p",[t._v("配置nginx文件"),n("code",[t._v("/home/nginx/conf.d/ws.conf")]),t._v("：")]),t._v(" "),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[t._v("upstream target-server "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  server api_online:3001 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("fail_timeout")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# listen on HTTP2/SSL")]),t._v("\nserver "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  listen "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(" ssl http2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  server_name ws.wayearn.com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ssl certs from letsencrypt")]),t._v("\n  ssl_certificate /home/acme/fullchain.pem"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_certificate_key /home/acme/key.pem"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# dhparam.pem")]),t._v("\n  ssl_dhparam /home/acme/dhparam.pem"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_session_timeout 5m"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_protocols TLSv1 TLSv1.1 TLSv1.2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_ciphers "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_prefer_server_ciphers on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  location / "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    proxy_set_header X-Forwarded-Ssl on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_redirect off"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_set_header Host "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$host")]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$server_port")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_set_header X-Real-IP "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_addr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_set_header X-Forwarded-For "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$proxy_add_x_forwarded_for")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_set_header X-Forwarded-Proto "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$scheme")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_pass http://target-server"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_set_header Upgrade "),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$http_upgrade")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    proxy_set_header Connection "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Upgrade'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# redirect HTTP and handle let's encrypt requests")]),t._v("\nserver "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  listen "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  server_name ws.wayearn.com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# send everything else to HTTPS")]),t._v("\n  rewrite ^"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(".*"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("$ https://"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$host")]),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$1")]),t._v(" permanent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),t._v(" "),n("li",[n("p",[t._v("添加dns解析")]),t._v(" "),n("p",[n("img",{attrs:{src:a(882),alt:"image-20210810223431309"}})])]),t._v(" "),n("li",[n("p",[t._v("导入镜像，启动api服务：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(883),alt:"image-20210810223550333"}})]),t._v(" "),n("p",[t._v("使用"),n("code",[t._v("docker-compose up -d")]),t._v("启动服务：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(884),alt:"image-20210810223613863"}})])]),t._v(" "),n("li",[n("p",[t._v("重启nginx服务：")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("docker restart some-nginx\n")])])]),n("p",[t._v("网络互访：")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("docker network inspect https\n")])])]),n("p",[n("img",{attrs:{src:a(885),alt:"image-20210810223801721"}})])])]),t._v(" "),n("h3",{attrs:{id:"排查问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#排查问题"}},[t._v("#")]),t._v(" 排查问题")]),t._v(" "),n("ul",[n("li",[t._v("常见的防火墙问题：")])]),t._v(" "),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看防火墙的运行状态")]),t._v("\nfirewall-cmd --state\n\nfirewall-cmd --add-port"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/tcp --permanenet\n\nfirewall-cmd --reload\n")])])]),n("ul",[n("li",[t._v("云服务商的放行策略：")])]),t._v(" "),n("p",[t._v("华为云示例：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(886),alt:"image-20210810221145314"}})]),t._v(" "),n("p",[t._v("腾讯云：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(887),alt:"image-20210810221210594"}})]),t._v(" "),n("h3",{attrs:{id:"小程序接口联调"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#小程序接口联调"}},[t._v("#")]),t._v(" 小程序接口联调")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("nginx启动之后，就可以访问"),n("code",[t._v("https://域名")]),t._v("了")])]),t._v(" "),n("li",[n("p",[t._v("导出测试数据库")]),t._v(" "),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[t._v("docker "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" -it mongodb mongodump -u "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v(" -d testdb -o /tmp/\n")])])]),n("p",[t._v("使用docker cp命令来复制目录：")]),t._v(" "),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[t._v("docker "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("容器id"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(":/tmp/testdb /tmp/本地目录\n")])])])]),t._v(" "),n("li",[n("p",[t._v("导入数据库")]),t._v(" "),n("p",[t._v("上传上面的本地目录的文件到线上的服务器。")]),t._v(" "),n("p",[t._v("mongodb恢复数据库的命令：")]),t._v(" "),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[t._v("docker "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" /home/docker/testdb "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("容器id"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(":/tmp/\n\ndocker "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" -it mongodb mongorestore -u "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v(" -d testdb /tmp/testdb\n")])])]),n("p",[n("img",{attrs:{src:a(888),alt:"image-20210810224430465"}})])])]),t._v(" "),n("p",[t._v("请求测试：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(889),alt:"image-20210810224507919"}})]),t._v(" "),n("ul",[n("li",[n("p",[t._v("微信小程序配置安全域名")]),t._v(" "),n("p",[t._v("开发 -> 开发设置 -> 安全域名")]),t._v(" "),n("p",[n("img",{attrs:{src:a(890),alt:"image-20210810224610237"}})]),t._v(" "),n("p",[t._v("添加域名：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(891),alt:"image-20210810224636162"}})]),t._v(" "),n("p",[t._v("​")]),t._v(" "),n("p",[t._v("下面即可以在微信开发者工具中进行测试了，取消"),n("code",[t._v("不校验合法域名")]),t._v("：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(892),alt:"image-20210810224714543"}})])])])]},proxy:!0}])},[n("h1",{attrs:{id:"安全域名相关"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安全域名相关"}},[t._v("#")]),t._v(" 安全域名相关")]),t._v(" "),n("p",[t._v("微信小程序的安全域名必须是HTTPS，同时必须是在国内ICP备案的域名，本章来介绍如何使用acme.sh+nginx配置https与申请SSL证书。")]),t._v(" "),n("h2",{attrs:{id:"ssl证书申请"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ssl证书申请"}},[t._v("#")]),t._v(" SSL证书申请")]),t._v(" "),n("h3",{attrs:{id:"前置准备"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前置准备"}},[t._v("#")]),t._v(" 前置准备")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("申请域名：阿里云、腾讯云等各家云服务商；")])]),t._v(" "),n("li",[n("p",[t._v("有一台云主机，有公网的IP，最好进行过备案；如果没有国内的服务器，也可以注册一台国外的服务器，地址1："),n("a",{attrs:{href:"https://bwh81.net/aff.php?aff=6389",target:"_blank",rel:"noopener noreferrer"}},[t._v("搬瓦工"),n("OutboundLink")],1),t._v("，地址2："),n("a",{attrs:{href:"https://www.vultr.com/?ref=6862890",target:"_blank",rel:"noopener noreferrer"}},[t._v("vultr"),n("OutboundLink")],1),t._v("；")])]),t._v(" "),n("li",[n("p",[t._v("云主机的操作系统：Centos 7+（"),n("u",[t._v("以下所有演示内容，均为Centos 7")]),t._v("）或者Ubuntu 16LTS+；")])]),t._v(" "),n("li",[n("p",[t._v("DNS解析：DNSpod，cloudflare；")]),t._v(" "),n("p",[t._v("配置域名进行解析：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(893),alt:"image-20210810145545806"}})]),t._v(" "),n("p",[t._v("使用A记录，配置自己的域名 -> 自己的云主机IP")]),t._v(" "),n("p",[t._v("使用ping命令检查 是否已经网络通了：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(894),alt:"image-20210810145801200"}})])])]),t._v(" "),n("h3",{attrs:{id:"整体架构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#整体架构"}},[t._v("#")]),t._v(" 整体架构")]),t._v(" "),n("p",[t._v("配置架构图：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(895),alt:"image-20210810144327946"}})]),t._v(" "),n("h3",{attrs:{id:"基本步骤"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#基本步骤"}},[t._v("#")]),t._v(" 基本步骤")]),t._v(" "),n("p",[t._v("借助"),n("a",{attrs:{href:"https://github.com/acmesh-official/acme.sh/wiki/%E8%AF%B4%E6%98%8E",target:"_blank",rel:"noopener noreferrer"}},[t._v("acme.sh"),n("OutboundLink")],1),t._v("进行申请SSL证书，以便微信接口部分的使用，下面演示的是DNSpod进行证书申请的过程。")]),t._v(" "),n("p",[n("strong",[t._v("主要步骤：")])]),t._v(" "),n("p",[t._v("前置：使用ssh命令连接到服务器 ->")]),t._v(" "),n("ol",[n("li",[n("p",[t._v("安装 "),n("strong",[t._v("acme.sh")])])]),t._v(" "),n("li",[n("p",[t._v("生成证书 ——"),n("a",{attrs:{href:"https://github.com/acmesh-official/acme.sh/wiki/dnsapi",target:"_blank",rel:"noopener noreferrer"}},[t._v("推荐DNS的方式"),n("OutboundLink")],1)]),t._v(" "),n("blockquote",[n("p",[t._v("支持的DNS列表："),n("a",{attrs:{href:"https://github.com/acmesh-official/acme.sh/tree/master/dnsapi",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/acmesh-official/acme.sh/tree/master/dnsapi"),n("OutboundLink")],1)])])]),t._v(" "),n("li",[n("p",[t._v("copy 证书到 nginx/apache 或者其他服务")])]),t._v(" "),n("li",[n("p",[t._v("更新证书")])]),t._v(" "),n("li",[n("p",[t._v("更新 "),n("strong",[t._v("acme.sh")])])])]),t._v(" "),n("h3",{attrs:{id:"acme-sh安装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#acme-sh安装"}},[t._v("#")]),t._v(" acme.sh安装")]),t._v(" "),n("p",[t._v("安装很简单, 一个命令:")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("curl  https://get.acme.sh | sh -s email=my@example.com\n")])])]),n("p",[n("img",{attrs:{src:a(896),alt:"image-20210810145930893"}})]),t._v(" "),n("p",[t._v("再次打开一个新的ssh终端，使用"),n("code",[t._v("crontab -e")]),t._v("(Centos)查看"),n("code",[t._v("acme.sh")]),t._v("自动创建的定时任务：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(897),alt:"image-20210810150236024"}})]),t._v(" "),n("p",[t._v("输入"),n("code",[t._v("i")]),t._v("进入编辑模式，调整如上图所示，使用"),n("code",[t._v(":wq")]),t._v("退出。")]),t._v(" "),n("blockquote",[n("p",[t._v("PS：上面的配置是每天的0点23分去执行一次脚本。")])]),t._v(" "),n("h3",{attrs:{id:"配置dns密钥"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置dns密钥"}},[t._v("#")]),t._v(" 配置DNS密钥")]),t._v(" "),n("p",[t._v("下面介绍了DNSpod、阿里云、Cloudflare的配置过程，大家可以根据自己的云服务商选择，过程类似。")]),t._v(" "),n("h4",{attrs:{id:"dnspod"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#dnspod"}},[t._v("#")]),t._v(" DNSpod")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("选择密钥管理：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(898),alt:"image-20210810150640094"}})])]),t._v(" "),n("li",[n("p",[t._v("创建密钥")]),t._v(" "),n("p",[n("img",{attrs:{src:a(899),alt:"image-20210810150731394"}})])]),t._v(" "),n("li",[n("p",[t._v("记录下来，后续使用：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(900),alt:"image-20210810150751582"}})])])]),t._v(" "),n("p",[t._v("配置密钥：")]),t._v(" "),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("DPI_Id")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1234"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("DPI_Key")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sADDsdasdgdsf"')]),t._v("\n")])])]),n("h4",{attrs:{id:"阿里云"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#阿里云"}},[t._v("#")]),t._v(" 阿里云")]),t._v(" "),n("p",[t._v("点击："),n("a",{attrs:{href:"https://ak-console.aliyun.com/#/accesskey",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://ak-console.aliyun.com/#/accesskey"),n("OutboundLink")],1),t._v("，申请密钥：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(901),alt:"image-20210810151001761"}})]),t._v(" "),n("p",[t._v("选择"),n("code",[t._v("编程访问")]),t._v("：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(902),alt:"image-20210810151252035"}})]),t._v(" "),n("p",[t._v("生成accessKey与密钥：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(903),alt:"image-20210810151319187"}})]),t._v(" "),n("p",[t._v("配置过程：")]),t._v(" "),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("Ali_Key")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sdfsdfsdfljlbjkljlkjsdfoiwje"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("Ali_Secret")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"jlsdflanljkljlfdsaklkjflsa"')]),t._v("\n")])])]),n("h4",{attrs:{id:"cloudflare"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#cloudflare"}},[t._v("#")]),t._v(" Cloudflare")]),t._v(" "),n("p",[t._v("配置"),n("a",{attrs:{href:"https://dash.cloudflare.com/profile",target:"_blank",rel:"noopener noreferrer"}},[t._v("页面"),n("OutboundLink")],1),t._v("：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(904),alt:"image-20210810151518194"}})]),t._v(" "),n("p",[t._v("配置过程：")]),t._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("CF_Key")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sdfsdfsdfljlbjkljlkjsdfoiwje"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("CF_Email")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"xxxx@sss.com"')]),t._v("\n")])])]),n("h3",{attrs:{id:"产生证书"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#产生证书"}},[t._v("#")]),t._v(" 产生证书")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("Dnspod:")]),t._v(" "),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[t._v("acme.sh --issue --dns dns_dpi -d example.com -d www.example.com\n")])])])]),t._v(" "),n("li",[n("p",[t._v("阿里云：")]),t._v(" "),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[t._v("acme.sh --issue --dns dns_ali -d example.com -d www.example.com\n")])])])]),t._v(" "),n("li",[n("p",[t._v("Cloudflare：")]),t._v(" "),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[t._v("acme.sh --issue --dns dns_cf -d example.com -d www.example.com\n")])])])])]),t._v(" "),n("blockquote",[n("p",[t._v("推荐域名通配符的写法：example.com 与 *.example.com，那么二级子域名，全部都可以使用https。")])]),t._v(" "),n("p",[t._v("过程1：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(905),alt:"image-20210810152354761"}})]),t._v(" "),n("p",[t._v("上面的图片是展示出在对域名进行校验。")]),t._v(" "),n("p",[t._v("过程2：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(906),alt:"image-20210810152415177"}})]),t._v(" "),n("p",[t._v("证书申请成功，证书所在位置。")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("cer 自签\nkey 密钥\nCA 中间证书\n把CA与cert链接到一起的证书，这个是后续放在nginx上的，用于服务器之间的协商\n")])])]),n("h2",{attrs:{id:"nginx配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx配置"}},[t._v("#")]),t._v(" Nginx配置")]),t._v(" "),n("h3",{attrs:{id:"前置准备-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前置准备-2"}},[t._v("#")]),t._v(" 前置准备")]),t._v(" "),n("p",[n("img",{attrs:{src:a(907),alt:"image-20210810205823556"}})]),t._v(" "),n("p",[t._v("步骤：")]),t._v(" "),n("ul",[n("li",[t._v("安装docker,docker-compose -> nginx")]),t._v(" "),n("li",[t._v("docker-compose来启动nginx")]),t._v(" "),n("li",[t._v("创建一个https docker网络 -> 共享给github, jenkins 等需要https的服务")]),t._v(" "),n("li",[t._v("配置"),n("code",[t._v("nginx.conf")]),t._v("配置文件，创建"),n("code",[t._v("conf.d")]),t._v("文件目录，可以创建虚拟域名"),n("code",[t._v("vhost.conf")]),t._v("文件")]),t._v(" "),n("li",[t._v("使用证书安装命令安装ssl证书  -> 到指定的目录")]),t._v(" "),n("li",[n("code",[t._v("docker-compose up -d")]),t._v("运行nginx容器 -> 测试cron定时任务脚本")])]),t._v(" "),n("h3",{attrs:{id:"证书安装命令"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#证书安装命令"}},[t._v("#")]),t._v(" 证书安装命令")]),t._v(" "),n("p",[t._v("Apache配置:")]),t._v(" "),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[t._v("acme.sh --install-cert -d example.com "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--cert-file      /path/to/certfile/in/apache/cert.pem  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--key-file       /path/to/keyfile/in/apache/key.pem  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--fullchain-file /path/to/fullchain/certfile/apache/fullchain.pem "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--reloadcmd     "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"service apache2 force-reload"')]),t._v("\n")])])]),n("p",[t._v("Nginx配置:")]),t._v(" "),n("div",{staticClass:"language-sh extra-class"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[t._v("acme.sh --install-cert -d example.com "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--key-file       /path/to/keyfile/in/nginx/key.pem  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--fullchain-file /path/to/fullchain/nginx/cert.pem "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--reloadcmd     "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"service nginx force-reload"')]),t._v("\n")])])]),n("blockquote",[n("p",[n("code",[t._v("--reloadcmd")]),t._v("可以指定docker容器进行重启，或者是指定运行shell脚本。")]),t._v(" "),n("p",[t._v("比如：")]),t._v(" "),n("p",[n("code",[t._v('--reloadcmd "docker restart some-nginx"')])])]),t._v(" "),n("h3",{attrs:{id:"dhparam-pem证书"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#dhparam-pem证书"}},[t._v("#")]),t._v(" dhparam.pem证书")]),t._v(" "),n("p",[t._v("创建一个目录："),n("code",[t._v("/home/keys")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("# 生成 dhparam.pem 文件, 在命令行执行任一方法:\n\n# 方法1: 很慢\nopenssl dhparam -out /etc/nginx/ssl/dhparam.pem 2048\n\n# 方法2: 较快\n# 与方法1无明显区别. 2048位也足够用, 4096更强\nopenssl dhparam -dsaparam -out /etc/nginx/ssl/dhparam.pem 4096\n")])])]),n("p",[t._v("把dhparam.pem复制到个人SSL证书安装相同的目录"),n("code",[t._v("/home/keys")]),t._v("。")]),t._v(" "),n("h3",{attrs:{id:"docker配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#docker配置"}},[t._v("#")]),t._v(" docker配置")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("手动创建网络")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("docker network create https\n")])])]),n("p",[n("img",{attrs:{src:a(908),alt:"image-20210810210138510"}})]),t._v(" "),n("blockquote",[n("p",[t._v("查看网络 "),n("code",[t._v("docker network ls")])]),t._v(" "),n("p",[t._v("检查网络的信息 "),n("code",[t._v("docker network inspect https")])])])]),t._v(" "),n("li",[n("p",[t._v("创建"),n("code",[t._v("docker-compose.yml")]),t._v("文件")])])]),t._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"3"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("web")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("latest\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"some-nginx"')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/nginx/nginx.conf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/etc/nginx/nginx.conf\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/nginx/conf.d"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/etc/nginx/conf.d\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /home/keys"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/home/keys\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# blog")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - /home/blog:/var/www")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"80:80"')]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"443:443"')]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker network create https")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("default")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("external")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https\n")])])]),n("h3",{attrs:{id:"nginx-conf配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx-conf配置"}},[t._v("#")]),t._v(" nginx.conf配置")]),t._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[t._v("user nginx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nworker_processes auto"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\npid /run/nginx.pid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nworker_rlimit_nofile "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("65535")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nevents "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置事件驱动模型，是内核2.6以上支持")]),t._v("\n\tuse epoll"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tworker_connections "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("65535")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\taccept_mutex off"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tmulti_accept off"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nhttp "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Basic Settings")]),t._v("\n\tsendfile on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\ttcp_nopush on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\ttcp_nodelay on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tsend_timeout "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("120")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tkeepalive_timeout "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("300")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tclient_body_timeout "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("300")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tclient_header_timeout "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("120")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\tproxy_read_timeout "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("300")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tproxy_send_timeout "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("300")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#tcp_nopush on;")]),t._v("\n\ttypes_hash_max_size "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4096")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tclient_header_buffer_size 16m"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tclient_max_body_size 4096m"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加nginx的配置文件目录 -> 用户后期添加vhost文件")]),t._v("\n\tinclude /etc/nginx/mime.types"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tinclude /etc/nginx/conf.d/*.conf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\tdefault_type application/octet-stream"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Logging Settings")]),t._v("\n\taccess_log /var/log/nginx/access.log"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\terror_log /var/log/nginx/error.log"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tlog_format main "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'$remote_addr - $remote_user [$time_local] \"$request\" '")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'$status $body_bytes_sent \"$http_referer\" '")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'"$http_user_agent" "$http_x_forwarded_for"\'')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 开启gzip")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("gzip")]),t._v(" on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启用gzip压缩的最小文件，小于设置值的文件将不会压缩")]),t._v("\n\tgzip_min_length 1k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# gzip 压缩级别，1-10，数字越大压缩的越好，也越占用CPU时间，后面会有详细说明")]),t._v("\n\tgzip_comp_level "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 进行压缩的文件类型。javascript有多种形式。其中的值可以在 mime.types 文件中找到。")]),t._v("\n\tgzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png font/ttf font/otf image/svg+xml"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 是否在http header中添加Vary: Accept-Encoding，建议开启")]),t._v("\n\tgzip_vary on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 禁用IE 6 gzip")]),t._v("\n\tgzip_disable "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"MSIE [1-6]\\."')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h3",{attrs:{id:"安装证书启动nginx"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装证书启动nginx"}},[t._v("#")]),t._v(" 安装证书启动nginx")]),t._v(" "),n("p",[n("img",{attrs:{src:a(909),alt:"image-20210810211832312"}})]),t._v(" "),n("p",[t._v("测试Nignx的配置文件：")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("docker exec -it some-nginx nginx -t\n")])])]),n("p",[n("img",{attrs:{src:a(910),alt:"image-20210810220403001"}})])])}),[],!1,null,null,null);s.default=e.exports},881:function(t,s,a){t.exports=a.p+"assets/img/image-20210810220929142.1537ad70.png"},882:function(t,s,a){t.exports=a.p+"assets/img/image-20210810223431309.368c5c94.png"},883:function(t,s,a){t.exports=a.p+"assets/img/image-20210810223550333.d0fedae0.png"},884:function(t,s,a){t.exports=a.p+"assets/img/image-20210810223613863.5fbb1359.png"},885:function(t,s,a){t.exports=a.p+"assets/img/image-20210810223801721.cc7b1e2f.png"},886:function(t,s,a){t.exports=a.p+"assets/img/image-20210810221145314.e34347c6.png"},887:function(t,s,a){t.exports=a.p+"assets/img/image-20210810221210594.0b72c5d5.png"},888:function(t,s,a){t.exports=a.p+"assets/img/image-20210810224430465.e62eb13b.png"},889:function(t,s,a){t.exports=a.p+"assets/img/image-20210810224507919.89fa22dc.png"},890:function(t,s,a){t.exports=a.p+"assets/img/image-20210810224610237.4224a675.png"},891:function(t,s,a){t.exports=a.p+"assets/img/image-20210810224636162.9792e446.png"},892:function(t,s,a){t.exports=a.p+"assets/img/image-20210810224714543.439e8328.png"},893:function(t,s,a){t.exports=a.p+"assets/img/image-20210810145545806.a0e07748.png"},894:function(t,s,a){t.exports=a.p+"assets/img/image-20210810145801200.cc140063.png"},895:function(t,s,a){t.exports=a.p+"assets/img/image-20210810144327946.bbb98c11.png"},896:function(t,s,a){t.exports=a.p+"assets/img/image-20210810145930893.237427d0.png"},897:function(t,s,a){t.exports=a.p+"assets/img/image-20210810150236024.e82227d2.png"},898:function(t,s,a){t.exports=a.p+"assets/img/image-20210810150640094.3d656e26.png"},899:function(t,s,a){t.exports=a.p+"assets/img/image-20210810150731394.b27888e3.png"},900:function(t,s,a){t.exports=a.p+"assets/img/image-20210810150751582.43ca872b.png"},901:function(t,s,a){t.exports=a.p+"assets/img/image-20210810151001761.9040174d.png"},902:function(t,s,a){t.exports=a.p+"assets/img/image-20210810151252035.d404c680.png"},903:function(t,s,a){t.exports=a.p+"assets/img/image-20210810151319187.d113629f.png"},904:function(t,s,a){t.exports=a.p+"assets/img/image-20210810151518194.3045c842.png"},905:function(t,s,a){t.exports=a.p+"assets/img/image-20210810152354761.b8f93ecb.png"},906:function(t,s,a){t.exports=a.p+"assets/img/image-20210810152415177.a8f72743.png"},907:function(t,s,a){t.exports=a.p+"assets/img/image-20210810205823556.b18f986b.png"},908:function(t,s,a){t.exports=a.p+"assets/img/image-20210810210138510.dce600c7.png"},909:function(t,s,a){t.exports=a.p+"assets/img/image-20210810211832312.c848f3ae.png"},910:function(t,s,a){t.exports=a.p+"assets/img/image-20210810220403001.ba89c359.png"}}]);